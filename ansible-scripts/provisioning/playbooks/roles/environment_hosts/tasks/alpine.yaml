---
- name: alpine - install requirements
  apk:
    name: openresolv
    state: latest
    update_cache: true

- name: alpine - install requirements
  apk:
    name: openrc-doc
    state: latest
    update_cache: true

- name: alpine - delete file
  become: yes
  ignore_errors: yes
  file:
    state: absent
    path: /etc/resolvconf.conf

- name: alpine - create file /etc/resolvconf.conf
  become: yes
  ignore_errors: yes
  file:
    path: "/etc/resolvconf.conf"
    state: touch

- name: alpine - recreate /etc/resolvconf.conf.
  become: yes
  lineinfile:
    path: "/etc/resolvconf.conf"
    line: "{{ item }}"
  with_items:
    - '# Generated by Ansible provisioning/environment_hosts'
    - 'resolv_conf=/etc/resolv.conf'
    - 'search_domains="{{ provisioning.domain }}"'
    - 'name_servers="{{ provisioning.nameserver1 }} {{ provisioning.nameserver2 }}"'

- name: alpine - delete file /etc/local.d/resolvconf.start
  become: yes
  ignore_errors: yes
  file:
    state: absent
    path: /etc/local.d/resolvconf.start


- name: alpine - create file /etc/local.d/resolvconf.start
  become: yes
  ignore_errors: yes
  file:
    path: "/etc/local.d/resolvconf.start"
    state: touch


- name: alpine - recreate /etc/local.d/resolvconf.start.
  become: yes
  lineinfile:
    path: "/etc/local.d/resolvconf.start"
    line: "{{ item }}"
  with_items:
    - '#!/bin/sh'
    - '# Generated by Ansible provisioning/environment_hosts'
    - '/usr/sbin/resolvconf -u'

- name: alpine - Changing perm of /etc/local.d/resolvconf.start, adding +x
  file:
    dest: /etc/local.d/resolvconf.start
    mode: a+x

- name: alpine - create {{ provisioning.alpine_interface }}.
  become: yes
  lineinfile:
    path: "/etc/network/interfaces"
    line: "{{ item }}"
  with_items:
    - '# Generated by Ansible provisioning/environment_hosts'
    - 'auto {{ provisioning.alpine_interface }}'
    - 'iface {{ provisioning.alpine_interface }} inet dhcp'
    - '        hostname {{ ansible_hostname }}'

- name: alpine - Restart Network
  command: "/etc/init.d/networking restart"
  become: true
  become_user: root

- name: alpine - Create Service
  command: "rc-update add local default"
  become: true
  become_user: root

- name: alpine - Start Service
  command: "rc-service local start"
  become: true
  become_user: root

- name: alpine - Configure /etc/hosts
  lineinfile:
    path: "/etc/hosts"
    regex: "alpine312 alpine312.localdomain"
    state: absent

